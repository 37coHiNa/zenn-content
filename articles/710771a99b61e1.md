---
title: "Google Apps Script ã® Web ã‚¢ãƒ—ãƒªã§ CORS åˆ¶ç´„ã‚’å›é¿ã—ã¦ Web Woker ã‚„ ES Modules ã‚’ä½¿ã†"
emoji: "ğŸ™"
type: "tech"
topics: ["googleappsscript"]
published: true
---

# å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä½¿ãˆãªã„
GASã§ä½œã£ãŸWebã‚¢ãƒ—ãƒªã§ä¸‹è¨˜ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```HTML:xxx.html
<!-- å‰ç•¥ -->
<script type="module">
import { module } from "https://xxx/module.js"
cosnt worker = new Worker( "https://xxx/worker.js" )
</script>
<!-- å¾Œç•¥ -->
```

é–‹ç™ºã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€ŒCORSã€ã‚„ã€ŒSOPã€ã¨ã„ã£ãŸæ–‡è¨€ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
CORSã¯ã‚ªãƒªã‚¸ãƒ³é–“ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰ã€SOPã¯åŒä¸€ç”Ÿæˆå…ƒãƒãƒªã‚·ãƒ¼ã®ã“ã¨ã§ã€ã–ã£ãã‚Šè¨€ã†ã¨ã€Œä»–ã®Webã‚µã‚¤ãƒˆã‹ã‚‰æŒã£ã¦ãã¦ã¯ã„ã‘ãªã„ã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

ã¤ã¾ã‚Šã€ä»–æ‰€ã‹ã‚‰æŒã£ã¦æ¥ã¦ã„ãªã„ã‚ˆã†ã«è¦‹ã›ã‚Œã°è§£æ±ºã—ã¾ã™ã€‚

# å¤±æ•—ä¾‹ ContentServiceã‚’ä½¿ã£ã¦ã¿ã‚‹
åŒã˜å¤±æ•—ã‚’ã—ãªã„ãŸã‚ã€ã¾ãšã¯å¤±æ•—ä¾‹ã®ç´¹ä»‹ã‹ã‚‰ã€‚

GASã«ã¯HTMLã‚’è¡¨ç¤ºã™ã‚‹`HtmlService`ã«å¯¾ã—ã¦ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãªã©ã‚’è¡¨ç¤ºã™ã‚‹`ContentService`ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

https://developers.google.com/apps-script/reference/content/content-service

ã“ã‚Œã‚’ä½¿ã£ã¦`doGet`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ¸¡ã—ãŸã¨ãã ã‘Workerç”¨ã®JSãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™ã‚ˆã†ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚

```JavaScript:main.gs
function doGet( e ) {
  const js = e.parameter.js
  if ( js != null ) {
    const content = HtmlService.createHtmlOutputFromFile( js ).getContent()
    return ContentService
    .createTextOutput( content )
    .setMimeType( ContentService.MimeType.JAVASCRIPT )
  }
  return HtmlService.createTemplateFromFile( "index" ).evaluate()
}
```

```HTML:index.html
<!-- å‰ç•¥ -->
<script>
const url = "<?= ScriptApp.getService().getUrl() ?>?js=worker.js"
const worker = new Worker( url )
worker.onmessage = console.log
worker.onerror = console.error
worker.postMessage( "Test Message." )
</script>
<!-- å¾Œç•¥ -->
```

```JavaScript:worker.js.html
self.addEventListener( "message", event => {
  self.postMessage( event.data )
} )
```

ã—ã‹ã—ã€ã“ã‚Œã§ã¯ä¸Šæ‰‹ãã„ãã¾ã›ã‚“ã€‚
ä½•æ•…ãªã‚‰HTMLãŒã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆ`iframe`ï¼‰ã§å…¥ã‚Œå­ã«ã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5czw182gynlp5qeii5xzzvxamm6b)

ã“ã¡ã‚‰ã§ä½œã£ãŸHTMLã¯ä¸€ç•ªå†…å´ã®`iframe`å†…ã«è¡¨ç¤ºã•ã‚Œã€ã“ã‚ŒãŒå¤–å´ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰è¦‹ãˆã‚‹URLï¼‰ã¨ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€çµå±€åŒä¸€ç”Ÿæˆå…ƒãƒãƒªã‚·ãƒ¼ã«é•åã—ã¾ã™ã€‚

# æˆåŠŸä¾‹ æ–‡å­—åˆ—ã‹ã‚‰Blobã‚’èµ·ã“ã—ã¦ObjectURLã‚’ç”Ÿæˆã™ã‚‹

æ‰€è¬‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ä½¿ã„ã¾ã™ã€‚

https://www.html5rocks.com/ja/tutorials/workers/basics/#toc-inlineworkers


GASå´ã«Workerã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦`getCode`ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’`index.html`å´ã§`google.script.run`ã‚’ä½¿ã£ã¦å‘¼ã³ã¾ã™ã€‚

```JavaScript:main.gs
function doGet( e ) {
  return HtmlService.createTemplateFromFile( "index" ).evaluate()
}

function getCode() {
  return HtmlService.createHtmlOutputFromFile( "worker.js" ).getContent()
}
```

```HTML:index.html
<!-- å‰ç•¥ -->
<script>
google.script.run
.withSuccessHandler( code => {
  const url = URL.createObjectURL( new Blob( [ code ], { type: "text/javascript" } ) )
  const worker = new Worker( url )
  worker.onmessage = console.log
  worker.onerror = console.error
  worker.postMessage( "Test Message." )
})
.withFailureHandler( console.error )
.getCode()
</script>
<!-- å¾Œç•¥ -->
```

```JavaScript:worker.js.html
self.addEventListener( "message", event => {
  self.postMessage( event.data )
} )
```

ä»¥ä¸Šï¼

ã‚³ãƒ¼ãƒ‰ã¯ Web Worker ã§èª¬æ˜ã—ã¾ã—ãŸãŒã€ES Modules ã®å ´åˆã¯ObjectURLã‚’ç”Ÿæˆã™ã‚‹ã¨ã“ã‚ã¾ã§ã¯ä¸€ç·’ã§ã€Dynamic Importã‚’ä½¿ãˆã°åŒæ§˜ã«å®Ÿç¾ã§ãã¾ã™ã€‚

https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/import#Dynamic_Import
