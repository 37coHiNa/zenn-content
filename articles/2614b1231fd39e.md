---
title: "Javascript ã§ Brainf**k ã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‚’æ›¸ã„ã¦ã¿ãŸ"
emoji: "ğŸ™"
type: "tech"
topics: ["javascript"]
published: true
---

â€»Brainf\*\*k ã®æ­£ã—ã„åç§°ã«ã¯å•é¡Œã®ã‚ã‚‹å˜èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€æœ¬è¨˜äº‹ã§ã¯ä¼ã›å­—ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

# Brainf\*\*k ã¨ã¯
å®Ÿè¡Œå½¢å¼ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ»ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã¨ã‚‚ã«100ãƒã‚¤ãƒˆå‰å¾Œã¨ã„ã†é©šç•°çš„å°å‹ã•ã§æœ‰åãªé›£è§£ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚

å®Ÿè¡Œç³»ã¯å†…éƒ¨ã«ä»¥ä¸‹ã®4ã¤ã®å¤‰æ•°ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

1. ãƒ‡ãƒ¼ã‚¿ã®å…¥ã£ãŸé…åˆ—
2. ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿
3. å‘½ä»¤ã®å…¥ã£ãŸé…åˆ—
4. å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿

## ãƒ‡ãƒ¼ã‚¿ã®å…¥ã£ãŸé…åˆ—ã¨ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿
å˜ãªã‚‹ã‚ªã‚¯ãƒ†ãƒƒãƒˆåˆ—ï¼ˆãƒã‚¤ãƒˆåˆ—ï¼‰ã§ã™ã€‚
é€šå¸¸ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ãŠã‘ã‚‹å¤‰æ•°ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ã¨è€ƒãˆã¦ã‚ˆã„ã§ã—ã‚‡ã†ã€‚
å¯å¤‰é•·é…åˆ—ã§ã‚‚å•é¡Œãªã„ã®ã§`Array`ã§ã‚‚è‰¯ã„ã®ã§ã™ãŒã€ä»Šå›ã¯`Uint8Array`ã¨ã—ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿ã¯ãƒ‡ãƒ¼ã‚¿ã®å…¥ã£ãŸé…åˆ—ã®ç‰¹å®šã®è¦ç´ ã‚’æŒ‡ã™æ·»å­—ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿ã®æŒ‡ã™è¦ç´ ã ã‘ãŒã€å¾Œè¿°ã™ã‚‹å‘½ä»¤ã§ã®æ“ä½œå¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚

## å‘½ä»¤ã®å…¥ã£ãŸé…åˆ—ã¨å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿
å‘½ä»¤ã¯å…¨éƒ¨ã§8ç¨®é¡ã‚ã‚Šã¾ã™ã€‚

| å‘½ä»¤ | æ„å‘³ |
| - | - |
| `>` | ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿ã®å€¤ã‚’åŠ ç®—ã—ã¾ã™ã€‚ |
| `<` | ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿ã®å€¤ã‚’æ¸›ç®—ã—ã¾ã™ã€‚ |
| `+` | ãƒ‡ãƒ¼ã‚¿ã‚’åŠ ç®—ã—ã¾ã™ã€‚ |
| `-` | ãƒ‡ãƒ¼ã‚¿ã‚’æ¸›ç®—ã—ã¾ã™ã€‚ |
| `.` | ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ |
| `,` | å…¥åŠ›ã‹ã‚‰ 1 ãƒã‚¤ãƒˆã‚’ãƒ‡ãƒ¼ã‚¿ã«ã—ã¾ã™ã€‚ |
| `[` | ãƒ‡ãƒ¼ã‚¿ãŒ 0 ãªã‚‰ã€å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã‚’å¯¾å¿œã™ã‚‹`]`ã®ã¨ã“ã‚ã¾ã§é€²ã‚ã¾ã™ã€‚ |
| `]` | ãƒ‡ãƒ¼ã‚¿ãŒ 0 ã§ã¯ãªã„ãªã‚‰ã€å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã‚’å¯¾å¿œã™ã‚‹`[`ã®ã¨ã“ã‚ã¾ã§æˆ»ã—ã¾ã™ã€‚ |
â€»è¡¨å†…ã®ã€Œãƒ‡ãƒ¼ã‚¿ã€ã¯ã€Œãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ã‚¿ã®æŒ‡ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿é…åˆ—ã®å€¤ã€ã‚’æ„å‘³ã—ã¾ã™ã€‚

å‘½ä»¤ã®å…¥ã£ãŸé…åˆ—ã¯ Brainf\*\*k ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ç­‰ã—ã„ã§ã™ã€‚
ã“ã“ã§ã‚ãˆã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨å‘¼ã‚“ã§ã„ãªã„ã®ã¯ **å‘½ä»¤ã«è©²å½“ã—ãªã„æ–‡å­—ã¯ç„¡è¦–ã™ã‚‹** ã¨ã„ã†ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ãŸã‚ã§ã™ã€‚
å¾Œè¿°ã™ã‚‹ç†ç”±ã«ã‚ˆã‚Šã€å®Ÿè£…ã§ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ã¯åˆ¥ã®é…åˆ—ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚
ã‚‚ã¡ã‚ã‚“ã€ç‰¹ã«ç†ç”±ãŒãªã‘ã‚Œã°ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨åŒä¸€ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã¯1ã¤ã®å‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹ãŸã³ã«åŠ ç®—ã—ã¾ã™ã€‚
`[`ã‚„`]`ã§å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ãŒå¤‰å‹•ã—ãŸå ´åˆã€ãã®ç›´å¾Œã®å‘½ä»¤ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ãŒå‘½ä»¤ã®å…¥ã£ãŸé…åˆ—ã®é•·ã•ã«ç­‰ã—ããªã£ãŸã‚‰ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œçµ‚äº†ã§ã™ã€‚

# å®Ÿè£…
Brainf\*\*k ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã‚ã‹ã£ãŸã¨ã“ã‚ã§ã€æœ¬é¡Œã®ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã®å®Ÿè£…ã«å…¥ã‚Šã¾ã™ã€‚

## ã¾ãšã¯æ§‹æ–‡è§£æã™ã‚‹ï¼ˆparseï¼‰
ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã¾ãšã¯æ§‹æ–‡è§£æã—ã¾ã™ã€‚
ãã®ç†ç”±ã¨ã—ã¦ã¯ä»¥ä¸‹ã®3ã¤ã€‚

1. **ã‚³ãƒ¼ãƒ‰ãŒæ­£å½“ã‹äº‹å‰ã«ãƒã‚§ãƒƒã‚¯ã—ãŸã„**
`[`ã¨`]`ã®å¯¾å¿œé–¢ä¿‚ã‚’ç¢ºèªã™ã‚‹ã ã‘ã§ã™ãŒã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãªã‚‰ã°å®Ÿè¡Œå‰ã«ç¢ºèªã§ããŸæ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

2. **ã„ãšã‚Œã¯æ´¾ç”Ÿç³»ã«å¯¾å¿œã—ãŸã„**
Brainf\*\*k ã¯ãã®å˜ç´”ãªæ§‹æ–‡ã‹ã‚‰8ã¤ã®å‘½ä»¤ã«ç›¸å½“ã™ã‚‹æ–‡è¨€ã‚’æ§˜ã€…ãªã‚‚ã®ã«ç½®ãæ›ãˆãŸãŸãã•ã‚“ã®æ´¾ç”ŸãŒã‚ã‚Šã¾ã™ã€‚æ´¾ç”Ÿã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ãªå‡¦ç†ã‚’ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã«çµ„ã¿è¾¼ã‚€ã¨å¿…è¦ä»¥ä¸Šã«è¤‡é›‘åŒ–ã—ã¦ã—ã¾ã†ã§ã—ã‚‡ã†ã€‚

3. **ã„ãšã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚‚ä½œã‚ŠãŸã„**
æ§‹æ–‡è§£æã‚’ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã¨å…±æœ‰ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚‚æ´¾ç”Ÿç³»ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚‰ã®è¦æ±‚ã¯ã‚³ãƒ¼ãƒ‰ã¨å‘½ä»¤ã®å¯¾å¿œé–¢ä¿‚ã‚’è§£æ±ºã™ã‚‹å‡¦ç†ã‚’ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‹ã‚‰åˆ‡ã‚Šé›¢ã›ã°å®¹æ˜“ã«é”æˆã§ãã¾ã™ã€‚

## ã‚¤ãƒ³ãƒ—ãƒªã‚¿æœ¬ä½“
å…¥å‡ºåŠ›ã¯ Node.js ã§ã‚ã‚Œã°æ¨™æº–å…¥å‡ºåŠ›ã‚’ä½¿ãˆã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚
ã—ã‹ã—ã€Web ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã¯ãã® Web ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
ã‚ˆã£ã¦å®Ÿè¡Œæ™‚ã«æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã€å…¥å‡ºåŠ›å…ˆã¯ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‹ã‚‰åˆ‡ã‚Šé›¢ã—ã¾ã™ã€‚
æ–¹æ³•ã¨ã—ã¦ã¯å…¥åŠ›ã‚’ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§å—ã‘å–ã‚Šã€é€†ã«å‡ºåŠ›ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œãƒ¡ã‚½ãƒƒãƒ‰ã§è¿”ã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

æ§‹æ–‡è§£æã¯æ—¢ã«ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ã¯æ—¢ã«å…¥åŠ›ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã‚‹ã®ã«å…¥åŠ›ã‚’èª­ã‚‚ã†ã¨ã—ãŸå ´åˆã«ã®ã¿ç™ºç”Ÿã—ã¾ã™ã€‚

## å®Œæˆã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
ä»¥ä¸Šã®ä»•æ§˜ã‚’ç››ã‚Šè¾¼ã‚“ã§å®Œæˆã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã“ã¡ã‚‰ã§ã™ã€‚

```Javascript
/*
 * 0x01ãªã©ã®å€¤ã«ç‰¹ã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
 * é‡è¤‡ã—ãªã‘ã‚Œã°ãªã‚“ã§ã‚‚OKã§ã™ã€‚
 */
const Instruction = Object.freeze( {
  INCREMENT_POINTER: 0x01,
  DECREMENT_POINTER: 0x02,
  INCREMENT: 0x03,
  DECREMENT: 0x04,
  OUTPUT: 0x05,
  INPUT: 0x06,
  JUMP_FOWARD: 0x07,
  JUMP_BACK: 0x08,
} )

const DEFAULT_DATA_SIZE = 30000

/*
 * ãŸã 0ã®ã¿ã‚’è¿”ã™ãƒ€ãƒŸãƒ¼ã®å…¥åŠ›ã§ã™ã€‚
 * /dev/zeroã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚
 */
const DEFAULT_INPUT_STREAM = (function*(){
  for (;;) yield 0
})()

class BrainFKSyntaxError extends Error {

  constructor( ...args ) {
    super( ...args )
  }

}

class BrainFKRuntimeError extends Error {

  constructor( ...args ) {
    super( ...args )
  }

}

const parseCode = ( code ) => {

  /*
   * ä»¥ä¸‹ã®3ã¤ãŒæˆ»ã‚Šå€¤ã§ã™ã€‚
   * instructions: å‘½ä»¤ã®å…¥ã£ãŸé…åˆ—
   * jumpInfo    : [, ]ã§ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹å…ˆã®å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã®å€¤ã®å…¥ã£ãŸé€£æƒ³é…åˆ—
   * debugInfo   : å‘½ä»¤ãƒã‚¤ãƒ³ã‚¿ã®å€¤ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã®æ–‡å­—åˆ—ä½ç½®ã®å¯¾å¿œé–¢ä¿‚ã®å…¥ã£ãŸé€£æƒ³é…åˆ—
   */
  const instructions = [],
        jumpInfo = new Map,
        debugInfo = new Map

  const stack = []
  let index = 0, instructionPointer = 0
  for ( ; index < code.length; index ++ ) {

    let instruction

    switch ( code[ index ] ) {

      case ">":
        instruction = Instruction.INCREMENT_POINTER
        break

      case "<":
        instruction = Instruction.DECREMENT_POINTER
        break

      case "+":
        instruction = Instruction.INCREMENT
        break

      case "-":
        instruction = Instruction.DECREMENT
        break

      case ".":
        instruction = Instruction.OUTPUT
        break

      case ",":
        instruction = Instruction.INPUT
        break

      case "[":
        instruction = Instruction.JUMP_FOWARD
        stack.push( instructionPointer )
        break

      case "]":
        instruction = Instruction.JUMP_BACK
        if ( stack.length == 0 ) {
          throw new BrainFKSyntaxError( `missing "[" index=${ index }` )
        }
        const foward = stack.pop()
        jumpInfo.set( foward, instructionPointer )
        jumpInfo.set( instructionPointer, foward )
        break

      default:
        continue

    }

    debugInfo.set( instructionPointer, [ index, index + 1 ] )
    instructions.push( instruction )
    instructionPointer ++

  }

  if ( stack.length > 0 ) {
    throw new BrainFKSyntaxError( `missing "]" index=${ index }` )
  }

  return {
    instructions: Uint8Array.from( instructions ),
    jumpInfo,
    debugInfo,
  }

}

class BrainFKInterpreter {

  #instructions
  #jumpInfo
  #data
  #inputStream
  #debugInfo

  constructor( code, { dataSize = DEFAULT_DATA_SIZE, inputStream = DEFAULT_INPUT_STREAM } = {} ) {

    const { instructions, jumpInfo, debugInfo } = parseCode( code )
    this.#instructions = instructions
    this.#jumpInfo = jumpInfo
    this.#data = new Uint8Array( Number( dataSize ) )
    this.#inputStream = inputStream
    this.#debugInfo = debugInfo

  }

  async execute() {

    const outputs = []

    for await ( const [ ,,, output ] of this.step() ) {

      if ( output != null ) {

        outputs.push( output )

      }

    }

    return Uint8Array.from( outputs )

  }

  /*
   * ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã™ã‚‹ã“ã¨ã§ã€å‘½ä»¤ã”ã¨ã«ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œã§ãã¾ã™ã€‚
   */
  async * step() {

    const instructions = this.#instructions
    const jumpInfo = this.#jumpInfo
    const data = this.#data
    const debugInfo = this.#debugInfo

    for ( let instructionPointer = 0, dataPointer = 0; instructionPointer < instructions.length; instructionPointer ++ ) {

      let output = null

      switch ( instructions[ instructionPointer ] ) {

        case Instruction.INCREMENT_POINTER:
          ++ dataPointer
          break

        case Instruction.DECREMENT_POINTER:
          -- dataPointer
          break

        case Instruction.INCREMENT:
          ++ data[ dataPointer ]
          break

        case Instruction.DECREMENT:
          -- data[ dataPointer ]
          break

        case Instruction.OUTPUT:
          output = data[ dataPointer ]
          break

        case Instruction.INPUT:
          const input = await this.#inputStream.next()
          if ( input.done ) {
            throw new BrainFKRuntimeError( `input is already closed.` )
          }
          data[ dataPointer ] = input.value
          break

        case Instruction.JUMP_FOWARD:
          if ( data[ dataPointer ] == 0 ) {
            instructionPointer = jumpInfo.get( instructionPointer )
          }
          break

        case Instruction.JUMP_BACK:
          if ( data[ dataPointer ] != 0 ) {
            instructionPointer = jumpInfo.get( instructionPointer )
          }
          break

      }

      yield [ dataPointer, data[ dataPointer ], debugInfo.get( instructionPointer ), output ]

    }

  }

}
```

# ãŠã‚ã‚Š
ä»¥ä¸Šï¼
Brainf\*\*k è‡ªä½“ã¯å®Ÿç”¨çš„ã¨ã¯è¨€ã„é›£ã„ã§ã™ãŒã€ã‚¤ãƒ³ã‚¿ãƒ—ãƒªã‚¿ã‚„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’æ›¸ãç·´ç¿’ã«ã¯ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚
